"use strict";function PJaxRouter(t){this.router={history:[{href:window.location.href,title:document.title}]},this.cache=[],this._isLoading=!1,this._ajaxCalls=0,this._transitionsManager={override:!1,overrideDuration:50,isWaiting:!1},this.lastLinkClicked=null,this._mutations={mutationObserver:null,isActive:!1},this._initParams(t),this._initEvents()}PJaxRouter.prototype._initParams=function(t){this.params={container:document.body,cancelNavigationClass:null,cacheLinks:null,cacheNavigatedPages:!1,cacheLength:10,onStart:{value:function(){}},onReady:{value:function(){}},onLeaving:{duration:1e3,value:function(){}},onWaiting:{value:function(){}},onError:{value:function(){}}},Object.assign(this.params,t),this.params.container||(this.params.container=document.body),this.container=this.params.container,this.params.cacheNavigatedPages&&this._cacheResponse(window.location.href,document.documentElement.innerHTML),this.params.cacheLinks&&this._cacheContainerLinks()},PJaxRouter.prototype._initEvents=function(){var t=this;window.addEventListener("hashchange",function(){t.router.history.push({href:window.location.href,title:document.title})}),window.addEventListener("popstate",function(){var e,i,n,r;e=t.router.history[t.router.history.length-1].href,i=window.location.href;var a=!1;if(-1!=e.indexOf("#")){var o=e.indexOf("#");n=e.substring(0,o)}else n=e;if(-1!=i.indexOf("#")){o=i.indexOf("#");r=i.substring(0,o)}else r=i;n==r&&(a=!0),a||t._launchNavigation(window.location.href,!1)}),window.addEventListener("click",function(e){var i=e.target;if("A"!==i.name&&(i=i.closest("a")),i){var n=i.getAttribute("href");if(!(t.params.cancelNavigationClass&&i.classList.contains(t.params.cancelNavigationClass)||-1!==n.indexOf("mailto:")||i.getAttribute("download")||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey)){if(window.location.pathname===n||window.location.href===n)return e.preventDefault(),void e.stopPropagation();t.lastLinkClicked=i,e.preventDefault(),e.stopPropagation(),t._launchNavigation(n,!0)}}}),window.MutationObserver&&(this._mutations.isActive=!0,this._mutations.mutationObserver=new MutationObserver(function(e,i){t._observedMutation(e)}))},PJaxRouter.prototype._cacheResponse=function(t,e){var i={href:t,HTMLContent:this._parseResponseContent(e),title:e.match(/<title[^>]*>([^<]+)<\/title>/)[1]};this.cache.length>=this.params.cacheLength&&this.cache.splice(0,1),this.cache.push(i)},PJaxRouter.prototype._cacheContainerLinks=function(){for(var t=this.container.querySelectorAll(this.params.cacheLinks),e=0;e<t.length;e++){for(var i=t[e].href,n=!0,r=0;r<this.cache.length;r++)i===this.cache[r].href&&(n=!1);if(n){var a=this;this._AJAXCall(i,!1,function(t,e){a._cacheResponse(e,t)})}}},PJaxRouter.prototype._launchNavigation=function(t,e){if(!this._isLoading){this.router.nextHTMLContent=null,this.params.onStart.value(this.router.history[this.router.history.length-1].href,t);var i=this._transitionsManager.isOverriding?this._transitionsManager.overrideDuration:this.params.onLeaving.duration;if(this.cache.length>0)for(var n=null,r=0;r<this.cache.length;r++)this.cache[r].href===t&&(n=this.cache[r]);n?(this.router.nextHref=n.href,this.router.nextHTMLContent=n.HTMLContent,this.router.nextTitle=n.title):this._routing(t,e);var a=this;setTimeout(function(){a.params.onLeaving.value(a.router.history[a.router.history.length-1].href,t),a.router.nextHTMLContent?a._appendData(e):a._waitForData(e)},i)}},PJaxRouter.prototype._parseResponseContent=function(t){var e=document.createElement("html");e.innerHTML=t;var i="";if(this.container.getAttribute("id"))i="#"+this.container.getAttribute("id");else if(this.container.classList.length)for(var n=0;n<this.container.classList.length;n++)i+="."+this.container.classList[n];else i=this.container.tagName;var r=e.querySelector(i).innerHTML;return e=null,r},PJaxRouter.prototype._routing=function(t,e){if(this._isLoading=!0,this.router.nextHref=null,t?this.router.nextHref=t:this.router.history.length>0&&(this.router.nextHref=this.router.history[this.router.history.length-1].href),this.router.nextHref){var i=this;this._AJAXCall(t,e,function(t,e){var n=i._parseResponseContent(t);if(i.router.nextHTMLContent=n,i.router.nextTitle=t.match(/<title[^>]*>([^<]+)<\/title>/)[1],i.params.cacheNavigatedPages){for(var r=!0,a=0;a<i.cache.length;a++)e===i.cache[a].href&&(r=!1);r&&i._cacheResponse(e,t)}})}},PJaxRouter.prototype._AJAXCall=function(t,e,i){var n=new XMLHttpRequest,r=this;n.onreadystatechange=function(){4!==n.readyState||200!==n.status&&0!==n.status?4===n.readyState&&404!==n.status&&r._ajaxCalls<4?(0!==r._ajaxCalls||r._transitionsManager.isWaiting||(r._transitionsManager.isWaiting=!0,r.params.onWaiting.value(r.router.history[r.router.history.length-1].href,r.router.nextHref)),r._ajaxCalls++,r._routing(n.responseURL,e,i)):4===n.readyState&&(r._resetRoutingState(),r.params.onError.value(r.router.history[r.router.history.length-1].href,r.router.nextHref)):i&&i(n.response,n.responseURL)},n.open("GET",t,!0),n.setRequestHeader("Accept","text/html"),n.send(null)},PJaxRouter.prototype._waitForData=function(t){this._transitionsManager.isWaiting||(this._transitionsManager.isWaiting=!0,this.params.onWaiting.value(this.router.history[this.router.history.length-1].href,this.router.nextHref));var e=this,i=setInterval(function(){e.router.nextHTMLContent&&(clearInterval(i),e._appendData(t))},1e3)},PJaxRouter.prototype._observedMutation=function(t){for(var e=0;e<t.length;e++)if(t[e].addedNodes.length&&t[e].target.isEqualNode(this.container)){this._mutations.mutationObserver.disconnect();var i=this;setTimeout(function(){i._newContentAdded()},34);break}},PJaxRouter.prototype._newContentAdded=function(){var t=this;setTimeout(function(){t.params.onReady.value(t.router.history[t.router.history.length-2].href,t.router.history[t.router.history.length-1].href),t._resetRoutingState(),t.params.cacheLinks&&t._cacheContainerLinks()},0)},PJaxRouter.prototype._appendData=function(t){var e=this.router.nextTitle;t&&window.history.pushState({},e,this.router.nextHref),document.title=e,this.router.history.push({href:this.router.nextHref,title:e});var i=this.router.nextHTMLContent,n=this;i&&(this._mutations.isActive?this._mutations.mutationObserver.observe(this.container,{childList:!0}):setTimeout(function(){n._newContentAdded()},25*i.children.length),this.container.innerHTML=i)},PJaxRouter.prototype._resetRoutingState=function(){this._ajaxCalls=0,this._isLoading=!1,this._transitionsManager.isWaiting=!1,this._transitionsManager.isOverriding=!1},PJaxRouter.prototype.overrideTransitionDuration=function(t){this._transitionsManager.isOverriding=!0,this._transitionsManager.overrideDuration=t||50},PJaxRouter.prototype.isTransitionOverrided=function(){return this._transitionsManager.isOverriding};