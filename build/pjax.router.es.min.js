function PJaxRouter(t){this.router={history:[{href:window.location.href,title:document.title}]},this._isLoading=!1,this._ajaxCalls=0,this._transitionsManager={override:!1,overrideDuration:0,isWaiting:!1},this.lastLinkClicked=null,this._mutations={mutationObserver:null,isActive:!1},this._initParams(t),this._initEvents()}PJaxRouter.prototype._initParams=function(t){this.params={container:document.body,cancelNavigationClass:null,onStart:{value:function(){}},onReady:{value:function(){}},onLeaving:{duration:1e3,value:function(){}},onWaiting:{value:function(){}},onError:{value:function(){}}},Object.assign(this.params,t),this.params.container||(this.params.container=document.body),this.container=this.params.container},PJaxRouter.prototype._initEvents=function(){var t=this;window.addEventListener("hashchange",function(){t.router.history.push({href:window.location.href,title:document.title})}),window.addEventListener("popstate",function(){var e,i,n,r;e=t.router.history[t.router.history.length-1].href,i=window.location.href;var a=!1;if(-1!=e.indexOf("#")){var o=e.indexOf("#");n=e.substring(0,o)}else n=e;if(-1!=i.indexOf("#")){o=i.indexOf("#");r=i.substring(0,o)}else r=i;n==r&&(a=!0),a||t._launchAjaxNavigation(window.location.href,!1)}),window.addEventListener("click",function(e){var i=e.target;if("A"!==i.name&&(i=i.closest("a")),i){var n=i.getAttribute("href");if(!(t.params.cancelNavigationClass&&i.classList.contains(t.params.cancelNavigationClass)||-1!==n.indexOf("mailto:"))){if(window.location.pathname===n||window.location.href===n)return e.preventDefault(),e.stopPropagation(),!1;t.lastLinkClicked=e.target,e.preventDefault(),e.stopPropagation(),t._launchAjaxNavigation(n,!0)}}}),window.MutationObserver&&(this._mutations.isActive=!0,this._mutations.mutationObserver=new MutationObserver(function(e,i){t._observedMutation(e)}))},PJaxRouter.prototype._launchAjaxNavigation=function(t,e){if(!this._isLoading){this._routing(t,e),this.params.onStart.value(this.router.history[this.router.history.length-1].href,t);var i=this._transitionsManager.isOverriding?this._transitionsManager.overrideDuration:this.params.onLeaving.duration,n=this;setTimeout(function(){n.params.onLeaving.value(n.router.history[n.router.history.length-1].href,t),n.router.nextHTMLContent?n._appendData(e):n._waitForData(e)},i)}},PJaxRouter.prototype._routing=function(t,e){if(this._isLoading=!0,this.router.nextHref=null,t?this.router.nextHref=t:this.router.history.length>0&&(this.router.nextHref=this.router.history[this.router.history.length-1].href),this.router.nextHTMLContent=null,this.router.nextHref){var i=new XMLHttpRequest,n=this;i.onreadystatechange=function(){4!==i.readyState||200!==i.status&&0!==i.status?4===i.readyState&&404!==i.status&&n._ajaxCalls<4?(0!==n._ajaxCalls||n._transitionsManager.isWaiting||(n._transitionsManager.isWaiting=!0,n.params.onWaiting.value(n.router.history[n.router.history.length-1].href,n.router.nextHref)),n._ajaxCalls++,n._routing(n.router.nextHref,e)):4===i.readyState&&(n._resetRoutingState(),n.params.onError.value(n.router.history[n.router.history.length-1].href,n.router.nextHref)):n.router.nextHTMLContent=i.response},i.open("GET",t,!0),i.setRequestHeader("Accept","text/html"),i.send(null)}},PJaxRouter.prototype._waitForData=function(t){this._transitionsManager.isWaiting||(this._transitionsManager.isWaiting=!0,this.params.onWaiting.value(this.router.history[this.router.history.length-1].href,this.router.nextHref));var e=this,i=setInterval(function(){e.router.nextHTMLContent&&(clearInterval(i),e._appendData(t))},1e3)},PJaxRouter.prototype._observedMutation=function(t){for(var e=0;e<t.length;e++)if(t[e].addedNodes.length&&t[e].target.isEqualNode(this.container)){this._mutations.mutationObserver.disconnect();var i=this;setTimeout(function(){i._newContentAdded()},34);break}},PJaxRouter.prototype._newContentAdded=function(){var t=this;setTimeout(function(){t.params.onReady.value(t.router.history[t.router.history.length-2].href,t.router.history[t.router.history.length-1].href),t._resetRoutingState()},0)},PJaxRouter.prototype._appendData=function(t){var e=this.router.nextHTMLContent.match(/<title[^>]*>([^<]+)<\/title>/)[1];t&&window.history.pushState(this.router,e,this.router.nextHref),document.title=e,this.router.history.push({href:this.router.nextHref,title:e});var i=document.createElement("div");i.insertAdjacentHTML("beforeend",this.router.nextHTMLContent);var n=i.querySelector("#"+this.container.getAttribute("id"));i=null;var r=this;if(n&&n.children&&n.children.length>0){this._mutations.isActive?this._mutations.mutationObserver.observe(this.container,{childList:!0}):setTimeout(function(){r._newContentAdded()},25*n.children.length);for(var a=document.createDocumentFragment();n.hasChildNodes();)a.appendChild(n.firstChild);this.container.innerHTML="",this.container.appendChild(a)}},PJaxRouter.prototype._resetRoutingState=function(){this._ajaxCalls=0,this._isLoading=!1,this._transitionsManager.isWaiting=!1,this._transitionsManager.isOverriding=!1},PJaxRouter.prototype.overrideTransitionDuration=function(t){this._transitionsManager.isOverriding=!0,this._transitionsManager.overrideDuration=t||0},PJaxRouter.prototype.isTransitionOverrided=function(){return this._transitionsManager.isOverriding};module.exports={PJaxRouter};